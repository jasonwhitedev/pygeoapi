{% extends "base.html" %}
{% block title %}{{ super() }} {{ data['title'] }} {% endblock %}
{% block crumbs %}{{ super() }}
/ <a href="{{ data['collections_path'] }}">Collections</a>
{% for link in data['links'] %}
  {% if link.rel == 'collection' %} /
    <a href="{{ data['dataset_path'] }}">{{ link['title'] }}</a>
    {% set col_title = link['title'] %}
  {% endif %}
{% endfor %}
/ <a href="{{ data['items_path']}}">Items</a>
{% endblock %}
{% block extrahead %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
{% endblock %}

{% block body %}
  <section id="items"></section>
  <section id="collection">
    <h1>{% for l in data['links'] if l.rel == 'collection' %} {{ l['title'] }} {% endfor %}</h1>
    <p>Items in this collection.</p>
  </section>
  <section id="items">
    {% if data['features'] %}
    <div class="row">
      <div class="col-sm-12 col-md-6">
        <div class="row">
          <div class="col-sm-12">
            <div id="items-map"></div>
          </div>
          <div class="col-sm-12">
            <div class="row">
                <div class="col-sm-12">
                  Warning: Higher limits not recommended!
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12">
                  Limit:
                  <select id="limits">
                    <option value="10">10 (default)</option>
                    <option value="100">100</option>
                    <option value="1000">1,000</option>
                    <option value="2000">2,000</option>
                  </select>
                  <script>
                    var select = document.getElementById('limits');
                    let params = (new URL(document.location)).searchParams;
                    select.value = params.get('limit') || 10;
                    select.addEventListener('change', ev => {
                      var limit = ev.target.value;
                      document.location.search = `limit=${limit}`;
                    });
                  </script>
                </div>
            </div>
            <div class="row">
              <div class="col-sm-12">
                {% for link in data['links'] %}
                {% if link['rel'] == 'prev' and data['startindex'] > 0 %}
                <a role="button" href="{{ link['href'] }}">Prev</a>
                {% elif link['rel'] == 'next' and data['features'] %}
                <a role="button" href="{{ link['href'] }}">Next</a>
                {% endif %}
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-sm-12 col-md-6">
          <table class="striped">
            <thead>
            <tr>
                <th>id</th>
                {% for k, v in data['features'][0]['properties'].items() %}
                {% if loop.index < 5 %}
                <td>{{ k }}</td>
                {% endif %}
                {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for ft in data['features'] %}
              <tr>
                <td data-label="id"><a href="{{ data['items_path'] }}/{{ ft.id }}">{{ ft.id }}</a></td>
                  {% for k, v in ft['properties'].items() %}
                  {% if loop.index < 5 %}
                  <td data-label="{{ k }}">{{ v | urlize(20) }}</td>
                  {% endif %}
                  {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
          </table>
      </div>
    </div>
    {% else %}
    <div class="row col-sm-12">
        <p>No items</p>
    </div>
    {% endif %}
    </section>
{% endblock %}

{% block extrafoot %}
{% if data['features'] %}
    <script
        src="http://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
        crossorigin="anonymous">
    </script>
    <script>
    var map = L.map('items-map').setView([{{ 45 }}, {{ -75 }}], 5);
    map.addLayer(new L.TileLayer(
        '{{ config['server']['map']['url'] }}', {
            maxZoom: 18,
            attribution: '{{ config['server']['map']['attribution'] }}'
        }
    ));
    var geojson_data = {{ data['features'] |to_json }};
    var items = new L.GeoJSON(geojson_data, {
        onEachFeature: function (feature, layer) {
            var url = '{{ data['items_path'] }}/' + feature.id + '?f=html';
            var html = '<span><a href="' + url + '">' + feature.id + '</a></span>';
            layer.bindPopup(html);
        }
    });

    map.addLayer(items);
    map.fitBounds(items.getBounds());

    map.on('moveend',function(e){
        
        var bounds = map.getBounds();
        var newGeojson_data = [];

        $.ajax({
			url: '/user-update-map/items?f=jsonld&limit=200',
			//data: JSON.stringify(data),
			type: 'GET',
			success: function(response){
                response.features.forEach((featureElement) => {
                    if(featureElement.geometry.coordinates[1] < bounds._northEast.lat && 
                       featureElement.geometry.coordinates[0] < bounds._northEast.lng &&
                       featureElement.geometry.coordinates[1] > bounds._southWest.lng &&
                       featureElement.geometry.coordinates[0] > bounds._southWest.lng) {

                            geojson_data.forEach((geojsonElement) => {
                                if(geojsonElement.geometry.coordinates[0] == featureElement.geometry.coordinates[0] &&
                                   geojsonElement.geometry.coordinates[1] == featureElement.geometry.coordinates[1]) {
                                    newGeojson_data.push(geojsonElement);
                                }
                            })
                        }
                })

                var items = new L.GeoJSON(newGeojson_data, {
                    onEachFeature: function (feature, layer) {
                        var url = '{{ data['items_path'] }}/' + feature.id + '?f=html';
                        var html = '<span><a href="' + url + '">' + feature.id + '</a></span>';
                        layer.bindPopup(html);
                    }
                });

                map.eachLayer(function (items) {
                    map.removeLayer(items);
                });

                map.addLayer(new L.TileLayer(
                    '{{ config['server']['map']['url'] }}', {
                        maxZoom: 18,
                        attribution: '{{ config['server']['map']['attribution'] }}'
                    }
                ));
                map.addLayer(items);

                $(function () {
                    counter = 1;
                    var content = '';
                    content += '<thead><tr><th>id</td>';
                    Object.keys(newGeojson_data[0].properties).forEach(key => {
                        if(counter < 5) {
                            content += '<td>' + key + '</td>';
                        }
                        counter++;
                    });
                    newGeojson_data.forEach(geoItem => {
                        var counter = 1;
                        content += '<tr>';
                        content += '<td data-label="id"><a href="{{ data['items_path'] }}/' + geoItem.id + '">' + geoItem.id + '</a></td>';
                        Object.values(geoItem.properties).forEach(val => {
                            if(counter < 5) {
                                content += '<td>' + val + '</td>';
                            }
                            counter++;
                        });
                        content += '</tr>';
                    })
                    $('.striped').html(content);
                });

			},
			error: function(error){
				console.log(error);
			}
        });
        
    });

    </script>
{% endif %}
{% endblock %}
